from sqlalchemy import create_engine, select
from sqlalchemy.orm import Session
from sqlalchemy.dialects.postgresql import insert
from pgvector.sqlalchemy import Vector
import numpy as np
from models import *


DATABASE_URL = "postgresql://postgres:password@localhost:5432/Autobi_DB"
engine = create_engine(DATABASE_URL)
# intent_embedding=[-0.00037379091372713447, -0.045500900596380234, -0.05459802225232124, -0.0046586995013058186, 0.007590093184262514, 0.00035664293682202697, 0.01542946882545948, -0.037867311388254166, 0.05658888444304466, 0.042362112551927567, 0.011693176813423634, -0.039049819111824036, -0.006843848153948784, -0.03552379831671715, 0.04471033066511154, -0.08204370737075806, 0.006430616602301598, -0.01816701516509056, -0.04369698837399483, -0.02400149591267109, -0.020773913711309433, -0.01678735762834549, -0.006963270716369152, -0.01749403029680252, -0.0006952651310712099, -0.023011503741145134, 0.006460810080170631, 0.0010940153151750565, -0.011585655622184277, 0.03357626870274544, -0.031048782169818878, 0.043094512075185776, -0.028630925342440605, 0.03840579092502594, -0.02729501575231552, -0.014346132054924965, -0.07207323610782623, 0.021200906485319138, 0.023336196318268776, 0.020338190719485283, -0.007130923680961132, -0.023561783134937286, -0.02068931609392166, -0.023964503780007362, -0.0007177169318310916, -0.04622066393494606, -0.018672069534659386, 0.013534321449697018, 0.0031400411389768124, -0.041186485439538956, 0.029766403138637543, 0.004389600362628698, 0.03847954049706459, -0.05077902600169182, 0.003975336905568838, -0.04421626776456833, 0.024862278252840042, 0.02330763079226017, -0.007835577242076397, 0.00430781114846468, 0.05431360378861427, -0.011994563043117523, -0.019253002479672432, 0.0309684369713068, 0.01971924491226673, -0.08081715553998947, -0.0024718493223190308, -0.03095685876905918, 0.08260323107242584, 0.002797977766022086, -0.0194545928388834, -0.002206415170803666, 0.038258202373981476, 0.010301977396011353, -0.035138197243213654, -0.13421356678009033, -0.00920959934592247, 0.1113537847995758, 0.023386703804135323, 0.010848467238247395, -0.023399967700242996, -0.035313330590724945, -0.03573211282491684, -0.01552737969905138, -0.02459290437400341, 0.060439206659793854, -0.07346279174089432, -0.03444038704037666, 0.012068700976669788, 0.010711821727454662, -0.004411248490214348, 0.026105519384145737, 0.01752707175910473, -0.046746160835027695, 0.022734293714165688, 0.04947005212306976, -0.015855873003602028, -0.01728326454758644, -0.0047013829462230206, -0.02792278118431568, -0.02689804509282112, 0.016051143407821655, -0.008947760798037052, -0.01711043156683445, 0.0195261649787426, 0.023899244144558907, 0.02881801128387451, -0.012295949272811413, -0.08929675072431564, 0.03652307018637657, -0.050238147377967834, -0.008433980867266655, -0.048721905797719955, -0.06508312374353409, 0.07725760340690613, -0.02975143864750862, -0.027219338342547417, 0.07322514057159424, 0.0138960350304842, 0.05663367360830307, 0.040550243109464645, -0.008346792310476303, 0.06387630850076675, 0.038152702152729034, 0.020257819443941116, -0.0004104094114154577, -0.0022280877456068993, 0.04140212759375572, 0.0852174386382103, 0.07769203186035156, -0.012109111994504929, -0.041695013642311096, 0.02764505334198475, 0.0077412971295416355, 0.03953178972005844, -0.01764235645532608, 0.027111517265439034, 0.025377348065376282, 0.06895039230585098, 0.009618556126952171, 0.003899181727319956, -0.002058043610304594, -0.02409457042813301, 0.029865998774766922, -0.033961810171604156, 0.028367044404149055, -0.052047085016965866, -0.026087025180459023, 0.020713932812213898, -0.024614637717604637, -0.0364319309592247, 0.005857500247657299, -0.029516808688640594, 0.03736283630132675, 0.04628869518637657, 0.001998634310439229, -0.055276039987802505, 0.010159884579479694, 0.01306685246527195, 0.059537846595048904, 0.08055242896080017, 0.05665286257863045, 0.012606150470674038, -0.005034721456468105, -0.003366866149008274, -0.032636236399412155, -0.012273837812244892, -0.01248965784907341, -0.02921002171933651, -0.045635271817445755, 0.0427299365401268, -0.012416177429258823, -0.05346288904547691, -0.01827479526400566, -0.0349736288189888, -0.05355072766542435, -0.01571369543671608, -0.0016114331083372235, -0.013650667853653431, -0.0071793897077441216, -0.022023383527994156, -0.06311523914337158, 0.006904385983943939, 0.015603149309754372, 0.013998348265886307, -0.005999124608933926, 0.026636933907866478, -0.01009751483798027, 0.008355998434126377, -0.03274033963680267, -0.01672368124127388, -0.017131555825471878, -0.027728496119379997, -0.004705807659775019, -0.01627185009419918, -0.0042741126380860806, -0.007722652982920408, 0.07029250264167786, -0.003004915313795209, -0.037886302918195724, -0.03704116865992546, 0.07168080657720566, -0.00755729665979743, 0.011602426879107952, 0.003815088188275695, 0.015744807198643684, 0.054495248943567276, -0.060592908412218094, -0.026618007570505142, -0.0028470277320593596, -0.019139409065246582, 0.021457377821207047, -0.026790481060743332, -0.04549611359834671, 0.013206633739173412, -0.009103081189095974, 0.05004110187292099, 0.044517334550619125, 0.017251290380954742, -0.04091005027294159, -0.03196421265602112, -0.011066721752285957, -0.040577903389930725, 0.02338857762515545, -0.02324635721743107, -0.01849166676402092, 0.06240701675415039, 0.04190341383218765, 0.016243888065218925, -0.048121802508831024, 0.05469640716910362, 0.07528218626976013, 0.0280844047665596, 0.005603775382041931, 0.07252448797225952, -0.022141585126519203, -0.013558557257056236, 0.03416093811392784, -0.004013595171272755, 0.00860106572508812, -0.026689885184168816, 0.030523749068379402, 0.06531636416912079, 0.06002907082438469, -0.06541337072849274, 0.016073258593678474, -0.010811028070747852, 0.03609039634466171, 0.0008988650515675545, 0.015686944127082825, -0.027004312723875046, -0.022119859233498573, -0.013595412485301495, 0.010507333092391491, -0.04999752715229988, 0.015738263726234436, -0.07660871744155884, -0.002099628560245037, 0.012076584622263908, 0.029158510267734528, 0.049216754734516144, 0.009423942305147648, -0.020475678145885468, 0.0414179265499115, -0.018101701512932777, -0.03990168124437332, -0.004943015985190868, -0.002000630833208561, 0.005398406647145748, -0.00758399348706007, -0.0087276641279459, -0.021812299266457558, 0.056697845458984375, 0.04363206773996353, 0.009764895774424076, 0.025516027584671974, 0.003163380781188607, 0.03192251920700073, 0.03080817125737667, -0.044821493327617645, -0.04333445429801941, 0.04210599139332771, 0.015424859710037708, -0.03186298906803131, -0.01778138428926468, -0.004012187942862511, 0.0022981923539191484, 0.019295964390039444, 0.0014207189669832587, -0.07389306277036667, -0.034628331661224365, -0.025679724290966988, -0.04579303786158562, -0.05006374791264534, -0.009276610799133778, -0.0033876432571560144, -0.05505674332380295, 0.051182933151721954, 0.04233767092227936, -0.03101411648094654, 1.6589789083809592e-05, -0.019018424674868584, -0.008284532465040684, -0.042901359498500824, 0.04710891842842102, 0.013565006665885448, -0.023320939391851425, -0.04420200735330582, -0.026109930127859116, -0.02941896952688694, 0.023407749831676483, -0.03172263130545616, -0.02874048613011837, -0.009891836903989315, 0.039387185126543045, 0.03731047734618187, 0.0025013748090714216, 0.019635304808616638, -0.040597837418317795, 0.0605793222784996, -0.02395278587937355, 0.01645049825310707, 0.007222177926450968, -0.005310141481459141, 0.007923887111246586, 0.02828032150864601, -0.05323202908039093, -0.0006718370132148266, 0.03845670074224472, 0.011540690436959267, 0.04218535125255585, 0.03666531667113304, -0.0025168410502374172, 0.05565623193979263, -0.0033358607906848192, 0.01756339520215988, -0.06955704838037491, -0.014434007927775383, -0.02484309673309326, 0.024240626022219658, 0.039835914969444275, -0.018790680915117264, -0.04100406914949417, -0.03138104826211929, 0.057883504778146744, -0.027475450187921524, 0.028316641226410866, -0.03152726963162422, 0.03260444104671478, 0.02862747199833393, -0.004305089358240366, 0.12598581612110138, -0.0023227022029459476, -0.012439267709851265, -0.01127956248819828, -0.0239717960357666, 0.04457612335681915, -0.05294184014201164, 0.030826939269900322, -0.06251673400402069, -0.04541490599513054, 0.028362521901726723, 0.004304742440581322, 0.02646319754421711, 0.01261302549391985, 0.0014459834201261401, -0.041228391230106354, 0.0015629760455340147, 0.011351754888892174, 0.04494958370923996, 0.02579091489315033, -0.07561621814966202, 0.006713783368468285, 0.01582474634051323, -0.022741328924894333, -0.02011226862668991, -0.033463187515735626, -0.044926661998033524, 0.016842637211084366, 0.005254003219306469, 0.01087209489196539, -0.006264833267778158, 0.029190275818109512, 0.05873759835958481, 0.049112606793642044, -0.011298127472400665, 0.026001473888754845, 0.05139463394880295, -0.035262636840343475, 0.05769874528050423, -0.011197664774954319, 0.05058835819363594, 0.0921754390001297, 0.0020615190733224154, 0.048969242721796036, -0.01718904823064804, -0.04170330613851547, -0.013761923648416996, 0.0157847311347723, -0.012914097867906094, -0.03946772962808609, -0.03557678312063217, -0.05499092489480972, -0.0028189667500555515, 0.020335355773568153, -0.06649447232484818, -0.026631087064743042, -0.02192072756588459, -0.016892004758119583, -0.06584540009498596, 0.029940888285636902, 0.06334569305181503, 0.01998087577521801, -0.1123182475566864, -0.008196165785193443, 0.022781532257795334, -0.01021287590265274, -0.03605027496814728, -0.011907374486327171, 0.05046403408050537, -0.01911834254860878, -0.0191054567694664, -0.005744460504502058, -0.05540973320603371, -0.03369251638650894, -0.03340085223317146, -0.015365835279226303, -0.02922404557466507, -0.020804844796657562, 0.005188558716326952, 0.019164737313985825, 0.012963357381522655, -0.007528261281549931, 0.0012993686832487583, -0.03286872059106827, -0.062221452593803406, 0.010787265375256538, 0.012571305967867374, -0.045667484402656555, -0.03433322161436081, 0.022473976016044617, -0.035107873380184174, -0.002440300304442644, -0.03221679478883743, -0.032252393662929535, -0.042325060814619064, 0.0401761569082737, -0.0524226538836956, -0.012165232561528683, -0.09177432209253311, 0.013857993297278881, -0.07569963485002518, -0.0435449443757534, -0.036360375583171844, -0.006701051723212004, -0.050650373101234436, 0.024029746651649475, 0.05974229425191879, 0.03633453696966171, 0.01780368573963642, -0.030241243541240692, -0.04336860030889511, -0.0427476204931736, -0.02303638681769371, -0.049602121114730835, -0.013755708932876587, 0.023402325809001923, -0.031239330768585205, 0.10119214653968811, 0.06969556957483292, 0.016644883900880814, -0.03270024061203003, 0.004576566629111767, 0.0364522747695446, 0.005787787027657032, -0.07790443301200867, -0.05819821357727051, 0.006721224170178175, 0.0036316735204309225, -0.06983759999275208, 0.01422601006925106, -0.026857001706957817, 0.051893994212150574, 0.02883511781692505, -0.015460153110325336, -0.029819073155522346, -0.015438448637723923, -0.018047457560896873, 0.029069725424051285, 0.024373222142457962, 0.016651010140776634, -0.012190178968012333, 0.029242461547255516, -0.021371183916926384, -0.008191528730094433, 0.04702915623784065, -0.050980210304260254, 0.005257768090814352, 0.012870806269347668, -0.002385266125202179, -0.01728314720094204, 0.0056803179904818535, -0.0072684925980865955, -0.04074427857995033, 0.03589191287755966, -0.026547787711024284, 0.017073597759008408, -0.011092344298958778, -0.0007925932295620441, -0.004413072019815445, -0.04756130650639534, 0.023119565099477768, 0.0021425229497253895, -0.029589811339974403, 0.041161902248859406, -0.016720222309231758, -0.0064818463288247585, 0.0675334483385086, -0.00747261056676507, -0.015487046912312508, 0.04806816205382347, 0.0013399396557360888, -0.09077905118465424, -0.003363327356055379, 0.05342783406376839, -0.09013549983501434, 0.016220083460211754, -0.016457924619317055, 0.01183493435382843, 0.0279458649456501, -0.007725200615823269, 0.014554453082382679, -0.11061286181211472, -0.0031473967246711254, -0.010143235325813293, -0.0012476348783820868, -0.027691734954714775, 0.030741548165678978, 0.04351228103041649, -0.01939750835299492, -0.0020028664730489254, -0.03227728605270386, -0.013278380036354065, 0.013269290328025818, -0.029304565861821175, 0.02001085877418518, 0.005684684496372938, -0.08754829317331314, -0.006729877553880215, -0.00685166334733367, -0.016313724219799042, -0.0046957507729530334, -0.0007217739475890994, -0.07940437644720078, 0.05489514023065567, 0.018188463523983955, -0.07069750130176544, 0.03864084556698799, 0.025125883519649506, 0.004839099012315273, -0.045995358377695084, 0.000755882472731173, -0.04516754671931267, -0.023555543273687363, 0.0006605791277252138, 0.042480386793613434, 0.006207351107150316, 0.005838130135089159, 0.09220301359891891, -0.0013566432753577828, -0.02280237339437008, 0.01134390477091074, 0.016384443268179893, -0.024400241672992706, 0.018177319318056107, -0.009128636680543423, -0.03606896474957466, -0.03355567902326584, -0.013049344532191753, -0.010519450530409813, 0.05133790150284767, 0.006605846341699362, 0.007359582465142012, 0.04042970389127731, -0.016273630782961845, 0.04068182036280632, 0.04390282928943634, 0.016755767166614532, 0.04869707673788071, -0.003127593779936433, -0.04542768374085426, 0.022570306435227394, -0.03407786041498184, -0.03437761217355728, 0.004226485267281532, 0.01543382927775383, -0.005154955666512251, -0.03215692192316055, -0.0244612917304039, -0.04361932724714279, 0.04681862145662308, -0.039430975914001465, 0.05519915372133255, 0.006430900190025568, 0.0376819483935833, 0.052042655646800995, 0.0014485940337181091, -0.020196430385112762, 0.024691779166460037, -0.004427984822541475, -0.006596061866730452, 0.030452504754066467, 0.06234332546591759, -0.007083072792738676, -0.04166526347398758, -0.009379437193274498, 0.038178376853466034, 0.018148135393857956, 0.003953874111175537, -0.028060412034392357, 0.00557402428239584, 0.00912549439817667, -0.021669982001185417, -0.02608555369079113, 0.022700423374772072, -0.024503204971551895, -0.0005142012378200889, -0.030737947672605515, 0.02297184430062771, 0.01581561379134655, 0.05300244688987732, 0.05809558182954788, 0.007704020943492651, -0.0026832239236682653, 0.002206329954788089, 0.056514494121074677, -0.005608071107417345, -0.040250491350889206, 0.014230934903025627, -0.0395546592772007, -0.0862085372209549, 0.006778016686439514, 0.03177225962281227, -0.021826138719916344, -0.0646953210234642, 0.05944206938147545, 0.038979507982730865, -0.053315140306949615, -0.01099397987127304, 0.02688409388065338, -0.027844151481986046, -0.04263105243444443, 0.049500517547130585, -0.0037105802912265062, -0.012038460932672024, -0.04747684299945831, 0.03134099394083023, -0.025823494419455528, 0.06590402126312256, 0.04573053494095802, -0.0445057637989521, -0.015433098189532757, 0.003910479135811329, -0.006198865361511707, -0.012210709974169731, 0.011567585170269012, -0.07503052055835724, -0.061019644141197205, -0.06610167026519775, 0.038552574813365936, -0.08726923167705536, 0.05118356645107269, -0.021160103380680084, -0.03223638981580734, 0.006563140079379082, -0.00756649486720562, -0.00853425171226263, -0.023275313898921013, 0.012057780288159847, 0.009847335517406464, -0.03173229098320007, -0.04057743400335312, -0.01067923754453659, 0.01771220564842224, -0.004330394323915243, 0.051748450845479965, -0.017787406221032143, -0.014155146665871143, -0.06642717868089676, -0.024584921076893806, 0.023079177364706993, -0.027628865092992783, -0.04145152494311333, -0.008016597479581833, 0.022865647450089455, 0.008833949454128742, 0.011502171866595745, -0.025165429338812828, 0.047161031514406204, 0.04361092671751976, -0.02469218336045742, -0.05850197374820709, 0.04871860891580582, 0.008886314928531647, -0.009243719279766083, 0.019127633422613144, -0.012115389108657837, -0.021246515214443207, 0.0015039583668112755, -0.01057260949164629, 0.05940559506416321, -0.03157610073685646, -0.05809912830591202, 0.04809136688709259, 0.003425595350563526, -0.00738126365467906, 0.01673349365592003, 0.0019987153355032206, -0.040277525782585144, 0.030813714489340782, 0.05618729814887047, -0.008051891811192036, -0.026727650314569473, -0.048142317682504654, -0.03187066316604614, 0.04954056441783905, 0.024813681840896606, 0.031516749411821365, 0.0034764492884278297, -0.02881329320371151, 0.08139876276254654, 0.01657550409436226, -0.0020895912311971188, 0.04407734423875809, -0.029271641746163368, 0.0669541209936142, -0.031436383724212646, -0.005544408690184355, -0.03446507826447487, -0.062221888452768326, -0.01625712960958481, 0.034455928951501846, 0.016152741387486458, 0.07151288539171219, 0.01314998883754015, -0.04002971947193146, 0.015651660040020943, -0.03478945046663284, -0.01477918028831482, -0.02395458146929741, -0.050664275884628296, 0.010835589841008186, 0.019829215481877327, 0.03502679988741875, 0.05473170429468155, -0.015853850170969963, -0.0021406731102615595, 0.019365547224879265, 0.0334075391292572, 0.0335036925971508, -0.07719403505325317, -0.008932542987167835, -0.0407404862344265, 0.0872993990778923, 0.011078406125307083, 0.03271676227450371, 0.004030729178339243, -0.00197412958368659]
# # Example: Query Intent Embedding (Assuming it's a 768-dimensional numpy array)
# query_intent_embedding = intent_embedding 

def domain_agent(query_intent_embedding,engine,limit=5):
    with Session(engine) as session:
        stmt = (
            select(
                DomainEmbedding,  # Fetch the embedding record
                Domain,           # Fetch the domain details
                1 - DomainEmbedding.embedding.cosine_distance(query_intent_embedding).label("similarity_score")
            )
            .join(Domain, DomainEmbedding.domain_id == Domain.id)
            .order_by(1 - DomainEmbedding.embedding.cosine_distance(query_intent_embedding).desc())
            .limit(5)  
        )

        results = session.execute(stmt).all()

        # Process the results
        for domain_embedding, domain, similarity_score in results:
            print(f"Domain: {domain.name}, Similarity Score: {similarity_score:.4f},domain_id:{domain.id}")
            
        domain_ids=[str(domain.id) for domain_embedding, domain, similarity_score in results]
    return domain_ids
    
#ouput 
# [UUID('5acff12a-480e-4a39-824e-e87e632efc81'), UUID('a0e9f9e4-5fb4-487e-a035-80746c47e0ec'), UUID('5acff12a-480e-4a39-824e-e87e632efc81'), UUID('a0e9f9e4-5fb4-487e-a035-80746c47e0ec'), UUID('f3a9bcb0-a6ba-4a68-ba28-32b3f8f4a8d2')]


# output 
            # Domain: Revenue Tracking, Similarity Score: 0.6673,domain_id:5acff12a-480e-4a39-824e-e87e632efc81
            # Domain: Customer Segmentation, Similarity Score: 0.6515,domain_id:a0e9f9e4-5fb4-487e-a035-80746c47e0ec
            # Domain: Revenue Tracking, Similarity Score: 0.6220,domain_id:5acff12a-480e-4a39-824e-e87e632efc81
            # Domain: Customer Segmentation, Similarity Score: 0.6195,domain_id:a0e9f9e4-5fb4-487e-a035-80746c47e0ec
            # Domain: Campaign Performance, Similarity Score: 0.5989,domain_id:f3a9bcb0-a6ba-4a68-ba28-32b3f8f4a8d2